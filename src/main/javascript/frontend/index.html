<!doctype html>
<style></style>

<html lang="de">
<head>
    <meta charset="utf-8">

    <title>Alien-Chess-Engine</title>
    <meta name="description" content="The HTML5 Herald">
    <meta name="author" content="SitePoint">
    <link rel="stylesheet" href="css/chessboard-1.0.0.min.css">
    <link rel="stylesheet" href="css/styles.css?v=1.0">

</head>

<body>
    <main>
        <section style="margin:0 auto; width:1024px;">
            <div style="margin:0 auto; width:500px;">
                <div id="board" style="width: 500px"></div>
            </div>
            <button id = "resetBoard">Reset Board</button>
        </section>
    </main>
</body>
</html>

<script src="js/jquery-3.4.1.min.js"></script>
<script src="js/prettify.min.js"></script>
<script src="js/chessboard-1.0.0.min.js"></script>
<script>

function onDrop (source, target, piece, newPos, oldPos, orientation) {

    var request = new XMLHttpRequest()

    // Open a new connection, using the GET request on the URL endpoint
    request.open('PATCH', 'http://localhost:8080/chess/figure/move/' + source + '/' + target, true)

    request.send();
    console.log('Source: ' + source)
    console.log('Target: ' + target)
    console.log('~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~')

    reload();
}

$('#resetBoard').on('click', function () {
    var request = new XMLHttpRequest()
    request.open('PUT', 'http://localhost:8080/chess/reset', true)
    request.send();
    reload();
})

function reload() {
    var request = new XMLHttpRequest()
    request.open('GET', 'http://localhost:8080/chess/figure/frontend', true)
    request.send();
    request.onload = function(e) {
        if (request.readyState == 4) {
            if (request.status == 200) {
                var data = JSON.parse(this.response)
                console.log(data.renderBoard)
                board.position(data.renderBoard)
            }
            else {
                console.error(request.statusText)
            }
        }
    };
}

function greySquare (square) {

  var whiteSquareGrey = '#a9a9a9'
  var blackSquareGrey = '#696969'
  var $square = $('#board .square-' + square)

  var background = whiteSquareGrey
  if ($square.hasClass('black-3c85d')) {
    background = blackSquareGrey
  }

  $square.css('background', background)
}

function removeGreySquares () {
  $('#board .square-55d63').css('background', '')
}

function onMouseoverSquare (square, piece) {
  // get list of possible moves for this square
  var request = new XMLHttpRequest()
    request.open('GET', 'http://localhost:8080/chess/figure/move/possible/' + square, true)
    request.send();
    request.onload = function(e) {
        if (request.readyState == 4) {
            if (request.status == 200) {
                var moves = JSON.parse(this.response)
                console.log(moves)
                
                // exit if there are no moves available for this square
                if (moves.length === 0) return

                // highlight the square they moused over
                greySquare(square)

                // highlight the possible squares for this piece
                for (var i = 0; i < moves.length; i++) {
                    greySquare(moves[i].xachse + moves[i].yachse)
                }

            }
            else {
                console.error(request.statusText)
            }
        }
    };
}

function onMouseoutSquare (square, piece) {
  removeGreySquares()
}

var config = {
    draggable: true,
    onDrop: onDrop,
    onMouseoverSquare: onMouseoverSquare,
    onMouseoutSquare: onMouseoutSquare
}

var board = Chessboard('board', config)

reload()

</script>
